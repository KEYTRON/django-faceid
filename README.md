# Django FaceID - Face Verification + Liveness

Практичный MVP для верификации лица в браузере с использованием веб-камеры, MediaPipe и InsightFace.

## Особенности

- **Liveness Detection**: Рандомные челленджи (повороты головы, моргание) для защиты от реплей-атак
- **WebSocket**: Реальное время отслеживания выполнения челленджей
- **InsightFace**: Серверная обработка эмбеддингов для точного сравнения
- **Красивый UX**: Оверлеи, прогресс-бар, адаптивный дизайн
- **Безопасность**: Не храним видео, только лучшие кадры и эмбеддинги

## Архитектура

```
Веб-камера → JS-детекция (MediaPipe) → визуализация → рандомные челленджи → 
3–5 лучших кадров → Django → эмбеддинги (InsightFace) → сравнение → вход
```

## Быстрый запуск

### 1. Настройка окружения

```bash
# Клонируем проект
cd django-faceid

# Настраиваем direnv (если есть)
direnv allow

# Создаем виртуальное окружение
python -m venv .venv
source .venv/bin/activate  # или .venv/Scripts/activate на Windows

# Устанавливаем зависимости
pip install -r requirements.txt
```

### 2. Инициализация Django

```bash
# Создаем миграции
python manage.py makemigrations

# Применяем миграции
python manage.py migrate

# Создаем суперпользователя (опционально)
python manage.py createsuperuser

# Собираем статические файлы
python manage.py collectstatic --noinput
```

### 3. Запуск

```bash
python manage.py runserver 0.0.0.0:8000
```

Откройте в браузере:
- http://localhost:8000/faceid/enroll/ — записать шаблон лица
- http://localhost:8000/faceid/verify/ — верификация по лицу

## Использование

### Запись шаблона (Enroll)

1. Откройте `/faceid/enroll/`
2. Разрешите доступ к камере
3. Нажмите "Начать челлендж"
4. Выполните случайные инструкции (повороты головы, моргание)
5. После успешного прохождения нажмите "Сохранить шаблон"

### Верификация (Verify)

1. Откройте `/faceid/verify/`
2. Введите имя пользователя
3. Нажмите "Пройти проверку"
4. Выполните челлендж
5. После успешной верификации нажмите "Войти"

## Технические детали

### Челленджи живости

- **Повороты головы**: yaw (влево/вправо) >= 15°
- **Подъем/опускание**: pitch (вверх/вниз) >= 10°
- **Моргание**: детекция через MediaPipe blendshapes

### Безопасность

- Порог сходства: 0.4 (cosine similarity)
- Рандомная последовательность челленджей
- WebSocket с таймаутом 25 секунд
- Не храним видео, только лучшие кадры

### Структура проекта

```
django-faceid/
├── config/                 # Django настройки
│   ├── settings.py
│   ├── urls.py
│   ├── asgi.py            # ASGI + WebSocket
│   └── routing.py         # WebSocket маршруты
├── apps/faceid/
│   ├── models.py          # FaceTemplate модель
│   ├── views.py           # REST API
│   ├── consumers.py       # WebSocket челленджи
│   ├── services/
│   │   └── insightface_backend.py  # Эмбеддинги
│   ├── utils/
│   │   └── similarity.py  # Сравнение векторов
│   ├── templates/         # HTML шаблоны
│   └── static/           # CSS/JS
└── requirements.txt
```

## Зависимости

- **Django 5.0+**: веб-фреймворк
- **Channels**: WebSocket поддержка
- **InsightFace**: эмбеддинги лиц
- **MediaPipe**: детекция в браузере
- **NumPy**: математические операции

## Ограничения MVP

- Нет инфракрасной глубины (риск высококачественных фото)
- Простая оценка позы головы (достаточно для челленджей)
- JSON хранение эмбеддингов (в проде лучше pgvector)
- InMemory WebSocket (для масштабирования нужен Redis)

## Путь в продакшн

1. **pgvector**: быстрый ANN-поиск, адаптивный порог
2. **Сложные анти-спуфы**: анализ муаров, микро-движения глаз
3. **Redis Channels**: масштабирование WebSocket
4. **Безопасность**: подписание сессий, rate-limit
5. **UX**: плавные подсказки, анализ освещения

## Лицензия

MIT License
